<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
/* ================= MAPA ================= */
const map = L.map('map').setView([-14.235, -51.9253], 4);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution: '© OpenStreetMap'
}).addTo(map);

/* ================= VARIÁVEIS ================= */
const resultsEl = document.getElementById("results");
const markers = [];

/* ================= CARREGAR CSV ================= */
fetch("Mapeamento_mestre.csv")
  .then(response => response.text())
  .then(csvText => {
    const data = parseCSV(csvText);
    renderData(data);
  })
  .catch(err => {
    console.error("Erro ao carregar CSV:", err);
  });

/* ================= PARSER CSV ================= */
function parseCSV(text){
  const linhas = text.split("\n").filter(l => l.trim() !== "");
  const cabecalho = linhas.shift().split(",");

  return linhas.map(linha => {
    const valores = linha.split(",");

    const obj = {};
    cabecalho.forEach((col, i) => {
      obj[col.trim().toLowerCase()] = valores[i]?.trim();
    });

    return obj;
  });
}

/* ================= RENDER MENU + MAPA ================= */
function renderData(dados){

  dados.forEach(item => {

    if(!item.latitude || !item.longitude) return;

    const lat = parseFloat(item.latitude);
    const lng = parseFloat(item.longitude);

    /* MARCADOR */
    const marker = L.marker([lat, lng]).addTo(map);
    marker.bindPopup(`
      <strong>${item.nome}</strong><br>
      ${item.cidade} - ${item.estado}<br>
      ${item.categoria}<br><br>
      ${item.descricao || ""}<br><br>
      <a href="${item.contato}" target="_blank">Entrar em contato</a>
    `);

    markers.push({ marker, item, lat, lng });

    /* ITEM MENU */
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <strong>${item.nome}</strong><br>
      ${item.cidade} - ${item.estado}<br>
      ${item.categoria}
    `;

    div.onclick = () => abrirDetalhes(item, lat, lng);
    resultsEl.appendChild(div);
  });
}

/* ================= DETALHES ================= */
function abrirDetalhes(item, lat, lng){
  document.body.classList.add("show-details");
  document.body.classList.remove("full-map");

  document.getElementById("details-panel").innerHTML = `
    <h2>${item.nome}</h2>

    <p><strong>Cidade:</strong> ${item.cidade} - ${item.estado}</p>
    <p><strong>Categoria:</strong> ${item.categoria}</p>
    <p>${item.descricao || ""}</p>

    ${item.contato ? `
      <a class="btn btn-contact" href="${item.contato}" target="_blank">
        Entrar em contato
      </a>
    ` : ""}

    <button class="btn btn-map" onclick="verNoMapa(${lat}, ${lng})">
      Ver no mapa
    </button>
  `;
}

/* ================= VER NO MAPA ================= */
function verNoMapa(lat, lng){
  document.body.classList.remove("show-details");
  document.body.classList.add("full-map");

  map.invalidateSize();
  map.setView([lat, lng], 15);

  markers.forEach(m => {
    if (m.lat === lat && m.lng === lng) {
      m.marker.openPopup();
    }
  });
}
</script>

<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Pesquisa Cultural ‚Äì Instituto Suma√∫ma</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
html,body{
  margin:0;
  height:100%;
  font-family:Arial,sans-serif;
}

/* ================= HEADER ================= */
.header{
  position:relative;
  height:160px;
  background:url('banner-capa.png') center/cover no-repeat;
}

.header-overlay{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 30px;
  background:rgba(0,0,0,.35);
}

/* LOGO */
.header-left img{
  height:100px;
  width:auto;
}

/* MENU DESKTOP */
.menu{
  display:flex;
  gap:30px;
}

.menu a{
  color:#fff;
  text-decoration:none;
  font-size:16px;
  cursor:pointer;
}

/* MENU MOBILE TOGGLE */
.menu-toggle{
  display:none;
  font-size:28px;
  color:#fff;
  cursor:pointer;
}

/* ================= MOBILE HEADER ================= */
@media(max-width:768px){
  .menu{display:none;}
  .menu-toggle{display:block;}
  .header{height:200px;}
}

/* ================= MOBILE MENU ================= */
.mobile-menu{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.9);
  z-index:5000;
  padding:40px 30px;
}

.mobile-menu a{
  display:block;
  color:#fff;
  font-size:22px;
  margin-bottom:25px;
  text-decoration:none;
}

.mobile-menu .close{
  font-size:28px;
  color:#fff;
  cursor:pointer;
  margin-bottom:40px;
}

/* ================= LAYOUT ================= */
#layout{
  display:flex;
  height:calc(100% - 160px);
}

/* ================= SIDEBAR ================= */
#sidebar{
  width:420px;
  background:#fff;
  border-right:1px solid #ddd;
  overflow-y:auto;
}

.sidebar-inner{padding:20px;}

input,select{
  width:100%;
  height:44px;
  padding:10px;
  margin-bottom:10px;
  box-sizing:border-box;
}

/* ================= RESULTADOS ================= */
.item{
  background:#0f3d2e;
  color:#fff;
  border-radius:4px;
  padding:12px;
  margin-bottom:10px;
  cursor:pointer;
}

.item:hover{background:#145743;}

.tag-pendente{
  color:#ffdd9a;
  font-size:12px;
}

/* ================= MAPA ================= */
#content{flex:1;position:relative;}
#map{width:100%;height:100%;}

/* ================= DETALHES (DESKTOP) ================= */
#details{
  display:none;
  position:absolute;
  right:0;
  top:0;
  width:420px;
  height:100%;
  background:#fff;
  border-left:1px solid #ddd;
  padding:20px;
  overflow-y:auto;
  z-index:1000;
}

.show-details #details{display:block;}
.full-map #sidebar,
.full-map #details{display:none;}

/* ================= MODAL LIVRO ================= */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.65);
  z-index:4000;
  align-items:center;
  justify-content:center;
}

.modal-content{
  background:#fff;
  width:90%;
  max-width:500px;
  padding:30px;
  border-radius:6px;
  text-align:center;
  position:relative;
}

.modal-content img{width:200px;margin-bottom:20px;}

.modal-content a{
  display:inline-block;
  margin:10px;
  padding:12px 18px;
  color:#fff;
  text-decoration:none;
  border-radius:4px;
}

.btn-read{background:#0f3d2e;}
.btn-download{background:#25D366;}

.close{
  position:absolute;
  top:10px;
  right:15px;
  font-size:22px;
  cursor:pointer;
}

/* ================= RESULT MODAL (MOBILE) ================= */
.result-modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.65);
  z-index:4500;
  align-items:center;
  justify-content:center;
}

.result-box{
  background:#fff;
  width:90%;
  max-width:500px;
  padding:25px;
  border-radius:6px;
  position:relative;
}
</style>
</head>

<body>

<header class="header">
  <div class="header-overlay">
    <div class="header-left">
      <a href="https://pesquisa.sumauma.org/">
        <img src="instituto_sumauma.png">
      </a>
    </div>

    <div class="menu-toggle" onclick="abrirMenu()">‚ò∞</div>

    <nav class="menu">
      <a href="https://pesquisa.sumauma.org/">In√≠cio</a>
      <a href="pesquisa.html">Pesquisa</a>
      <a onclick="abrirLivro()">Livro</a>
      <a href="ficha-tecnica.html">Ficha T√©cnica</a>
      <a href="https://www.sumauma.org/" target="_blank">Institucional</a>
    </nav>
  </div>
</header>

<div class="mobile-menu" id="mobileMenu">
  <div class="close" onclick="fecharMenu()">‚úï</div>
  <a href="https://pesquisa.sumauma.org/">In√≠cio</a>
  <a href="pesquisa.html">Pesquisa</a>
  <a onclick="abrirLivro();fecharMenu()">Livro</a>
  <a href="ficha-tecnica.html">Ficha T√©cnica</a>
  <a href="https://www.sumauma.org/" target="_blank">Institucional</a>
</div>

<div id="layout">

  <aside id="sidebar">
    <div class="sidebar-inner">
      <input type="text" id="search" placeholder="Buscar por nome...">
      <select id="filterEstado"><option value="">Todos os estados</option></select>
      <select id="filterCidade"><option value="">Todas as cidades</option></select>
      <select id="filterCategoria"><option value="">Todas as categorias</option></select>
      <div id="results"></div>
    </div>
  </aside>

  <section id="content">
    <div id="map"></div>
    <div id="details"></div>
  </section>

</div>

<!-- MODAL LIVRO -->
<div class="modal" id="modalLivro">
  <div class="modal-content">
    <span class="close" onclick="fecharLivro()">√ó</span>
    <img src="images/capa-livro.jpg">
    <p>
      Panorama das pr√°ticas comunicacionais quilombolas no Brasil,
      compreendendo a comunica√ß√£o como ato pol√≠tico, ancestral e de justi√ßa clim√°tica.
    </p>
    <a class="btn-read" href="PESQUISA - Pr√°ticas Comunicacionais e Culturais Quilombolas.pdf" target="_blank">üìñ Ler online</a>
    <a class="btn-download" href="PESQUISA - Pr√°ticas Comunicacionais e Culturais Quilombolas.pdf" download>üì• Baixar PDF</a>
  </div>
</div>

<!-- MODAL RESULTADO MOBILE -->
<div class="result-modal" id="resultModal">
  <div class="result-box">
    <span class="close" onclick="fecharResultado()">√ó</span>
    <div id="resultContent"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const map=L.map('map').setView([-14.235,-51.9253],4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let dados=[],markers=[];

fetch('Mapeamento_mestre.csv').then(r=>r.text()).then(t=>{
  dados=parseCSV(t);
  popularFiltros(dados);
  renderizar(dados);
  setTimeout(()=>map.invalidateSize(),300);
});

function parseCSV(text){
  const rows=[],headers=[];
  let cur=[],val='',q=false;
  for(let i=0;i<text.length;i++){
    const c=text[i],n=text[i+1];
    if(c=='"'&&q&&n=='"'){val+='"';i++;}
    else if(c=='"'){q=!q;}
    else if(c==','&&!q){cur.push(val);val='';}
    else if(c=='\n'&&!q){cur.push(val);rows.push(cur);cur=[];val='';}
    else{val+=c;}
  }
  if(val){cur.push(val);rows.push(cur);}
  headers.push(...rows.shift().map(h=>h.toLowerCase()));
  return rows.map(r=>{
    let o={};headers.forEach((h,i)=>o[h]=r[i]||'');return o;
  });
}

function popularFiltros(data){
  const estados=new Set(), categorias=new Set();
  data.forEach(d=>{
    if(d.estado) estados.add(d.estado);
    if(d.categoria) categorias.add(d.categoria);
  });
  estados.forEach(e=>filterEstado.innerHTML+=`<option>${e}</option>`);
  categorias.forEach(c=>filterCategoria.innerHTML+=`<option>${c}</option>`);
}

function atualizarCidades(){
  filterCidade.innerHTML='<option value="">Todas as cidades</option>';
  dados.filter(d=>!filterEstado.value||d.estado===filterEstado.value)
       .map(d=>d.cidade)
       .filter((v,i,a)=>v&&a.indexOf(v)===i)
       .forEach(c=>filterCidade.innerHTML+=`<option>${c}</option>`);
}

function aplicarFiltros(){
  const s=search.value.toLowerCase();
  renderizar(dados.filter(d=>
    (!s||d.nome.toLowerCase().includes(s)) &&
    (!filterEstado.value||d.estado===filterEstado.value) &&
    (!filterCidade.value||d.cidade===filterCidade.value) &&
    (!filterCategoria.value||d.categoria===filterCategoria.value)
  ));
}

search.oninput=aplicarFiltros;
filterEstado.onchange=()=>{atualizarCidades();aplicarFiltros();};
filterCidade.onchange=aplicarFiltros;
filterCategoria.onchange=aplicarFiltros;

function renderizar(lista){
  results.innerHTML='';
  markers.forEach(m=>map.removeLayer(m));
  markers=[];
  lista.forEach(d=>{
    const temLoc=d.latitude&&d.longitude&&!isNaN(d.latitude);
    const div=document.createElement('div');
    div.className='item';
    div.innerHTML=`
      <strong>${d.nome}</strong><br>
      ${d.cidade} - ${d.estado}<br>
      ${d.categoria}
      ${!temLoc?'<div class="tag-pendente">üìç Localiza√ß√£o pendente</div>':''}
    `;
    div.onclick=()=>abrirDetalhes(d);
    results.appendChild(div);
    if(temLoc) markers.push(L.marker([+d.latitude,+d.longitude]).addTo(map));
  });
}

function abrirDetalhes(d){
  const html=`
    <h2>${d.nome}</h2>
    <p><b>Cidade:</b> ${d.cidade} - ${d.estado}</p>
    <p><b>Categoria:</b> ${d.categoria}</p>
    ${d.descricao?`<p>${d.descricao}</p>`:''}
    ${d.contato?`<p><b>Contato:</b> ${d.contato}</p>`:''}
    ${d.link?`<a class="btn-read" href="${d.link}" target="_blank">Entrar em contato</a>`:''}
  `;
  if(window.innerWidth<=768){
    document.getElementById('resultContent').innerHTML=html;
    document.getElementById('resultModal').style.display='flex';
  }else{
    document.body.classList.add('show-details');
    details.innerHTML=html;
  }
}

function abrirLivro(){document.getElementById('modalLivro').style.display='flex';}
function fecharLivro(){document.getElementById('modalLivro').style.display='none';}
function abrirMenu(){document.getElementById('mobileMenu').style.display='block';}
function fecharMenu(){document.getElementById('mobileMenu').style.display='none';}
function fecharResultado(){document.getElementById('resultModal').style.display='none';}
</script>

</body>
</html>

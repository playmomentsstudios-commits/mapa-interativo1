<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Mapeamento Cultural ‚Äì Instituto Suma√∫ma</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
html,body{
  margin:0;
  font-family:Arial,sans-serif;
}

/* ===== BANNER TOPO ===== */
#banner-pesquisa{width:100%}

.banner-topo{
  background:url('banner-capa.png') center/cover no-repeat;
  min-height:200px;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#fff;
  padding:30px 0;
}

.banner-topo-inner{
  width:100%;
  max-width:1080px;
  padding:0 20px;
  box-sizing:border-box;
  display:flex;
  align-items:center;
  gap:20px;
}

/* LOGO REALIZA√á√ÉO */
.logo-realizacao img{
  max-height:70px;
}

/* TEXTO TOPO */
.banner-texto h1{
  font-size:32px;
  line-height:1.2;
  margin:0 0 8px 0;
}

.banner-texto p{
  font-size:16px;
  max-width:760px;
  margin:0;
}

/* ===== LAYOUT MAPA ===== */
#container{
  height:calc(100vh - 200px);
  position:relative;
}

#sidebar{
  position:absolute;
  top:0;left:0;bottom:0;
  width:32%;
  max-width:420px;
  background:#fff;
  overflow:auto;
  box-shadow:2px 0 6px rgba(0,0,0,.2);
  z-index:1000;
}

#map{
  position:absolute;
  top:0;right:0;bottom:0;
  left:32%;
}

/* UI */
.header{padding:12px;border-bottom:1px solid #ddd}
.tabs{display:flex;border-bottom:1px solid #ddd}
.tab{
  flex:1;
  padding:10px;
  text-align:center;
  cursor:pointer;
  font-weight:bold;
  background:#f5f5f5
}
.tab.active{background:#111;color:#fff}
.tab-content{display:none;padding:12px}
.tab-content.active{display:block}
input,select{width:100%;padding:8px;margin-bottom:6px}

/* LISTA */
.item{border-bottom:1px solid #ddd;padding:8px;cursor:pointer}
.item:hover{background:#f2f2f2}
.item.invalid{background:#fff3f3}
.badge{
  display:inline-block;
  background:#d9534f;
  color:#fff;
  padding:2px 6px;
  font-size:11px;
  border-radius:4px;
  margin-top:4px;
}

/* PDF */
.pdf-actions{display:flex;gap:10px}
.pdf-actions a,
.pdf-actions button{
  flex:1;
  padding:10px;
  border:none;
  background:#2e7d32;
  color:#fff;
  font-weight:bold;
  border-radius:4px;
  cursor:pointer;
}
iframe{width:100%;height:70vh;border:none}

/* ===== MOBILE ===== */
@media(max-width:768px){
  .banner-topo-inner{
    flex-direction:column;
    text-align:center;
  }

  .banner-texto h1{font-size:22px}

  #container{height:auto}
  #sidebar,#map{
    position:relative;
    width:100%;
    max-width:100%;
    left:0;
  }
  #map{height:50vh}
}
</style>
</head>

<body>

<!-- ===== BANNER TOPO ===== -->
<div id="banner-pesquisa">
  <div class="banner-topo">
    <div class="banner-topo-inner">

      <!-- LOGO REALIZA√á√ÉO (mantida a nomenclatura) -->
      <div class="logo-realizacao">
        <img src="instituto_sumauma.png" alt="Instituto Suma√∫ma">
      </div>

      <!-- TEXTO -->
      <div class="banner-texto">
        <h1>
          Corpos-territ√≥rios quilombolas<br>
          e o fio conectado da ancestralidade
        </h1>
        <p>
          entre as agendas de justi√ßa clim√°tica e as pr√°ticas culturais
          e comunicacionais
        </p>
      </div>

    </div>
  </div>
</div>

<!-- ===== MAPA ===== -->
<div id="container">

  <div id="sidebar">
    <div class="header"><h3>Mapeamento Cultural</h3></div>

    <div class="tabs">
      <div class="tab active" data-tab="mapa">Mapa Cultural</div>
      <div class="tab" data-tab="livro">Livro da Pesquisa</div>
    </div>

    <div id="tab-mapa" class="tab-content active">
      <input id="search" placeholder="Buscar por nome">
      <select id="stateFilter"><option value="">Estado</option></select>
      <select id="cityFilter"><option value="">Cidade</option></select>
      <select id="categoryFilter"><option value="">Categoria</option></select>
      <div id="list"></div>
    </div>

    <div id="tab-livro" class="tab-content">
      <div class="pdf-actions">
        <a href="PESQUISA - Pr√°ticas Comunicacionais e Culturais Quilombolas.pdf" download>
          üì• Baixar PDF
        </a>
        <button onclick="abrirPDF()">üìñ Ler aqui</button>
      </div>
      <iframe id="pdfViewer"></iframe>
    </div>
  </div>

  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const map=L.map('map').setView([-14.5,-52],4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'¬© OpenStreetMap'
}).addTo(map);

const markersLayer=L.layerGroup().addTo(map);
let markers=[];

fetch('Mapeamento_mestre.csv')
.then(r=>r.text())
.then(text=>{
  const lines=text.replace(/^\uFEFF/,'').trim().split('\n');
  const sep=lines[0].includes(';')?';':',';
  const headers=lines[0].split(sep).map(h=>h.trim().toLowerCase());

  const data=lines.slice(1).map(l=>{
    const c=l.split(sep);
    let o={};
    headers.forEach((h,i)=>o[h]=(c[i]||'').trim());

    const norm=v=>{
      if(!v) return null;
      v=v.replace(/\./g,'').replace(',','.');
      const n=parseFloat(v);
      return isNaN(n)?null:n;
    };

    o.latitude=norm(o.latitude);
    o.longitude=norm(o.longitude);
    o.valid=o.latitude&&o.longitude;
    o.nome=o.nome||'';
    return o;
  });

  populateFilters(data);
  applyFilters(data);

  function populateFilters(d){
    fill(stateFilter,[...new Set(d.map(x=>x.estado).filter(Boolean))]);
    fill(cityFilter,[...new Set(d.map(x=>x.cidade).filter(Boolean))]);
    fill(categoryFilter,[...new Set(d.map(x=>x.categoria).filter(Boolean))]);
  }

  function fill(el,arr){
    arr.forEach(v=>{
      const o=document.createElement('option');
      o.value=v;o.textContent=v;
      el.appendChild(o);
    });
  }

  function applyFilters(d){
    const f=d.filter(x=>
      (!search.value||x.nome.toLowerCase().includes(search.value.toLowerCase())) &&
      (!stateFilter.value||x.estado===stateFilter.value) &&
      (!cityFilter.value||x.cidade===cityFilter.value) &&
      (!categoryFilter.value||x.categoria===categoryFilter.value)
    );
    renderList(f);
    renderMap(f);
  }

  function popupHTML(d){
    return `<b>${d.nome}</b><br>${d.cidade||''} - ${d.estado||''}<br>${d.categoria||''}`;
  }

  function renderList(l){
    list.innerHTML='';
    l.forEach(d=>{
      const div=document.createElement('div');
      div.className='item'+(!d.valid?' invalid':'');
      div.innerHTML=`<strong>${d.nome}</strong><br>${d.cidade||''} - ${d.estado||''}<br>${d.categoria||''}${!d.valid?'<div class="badge">Localiza√ß√£o pendente</div>':''}`;
      if(d.valid){
        div.onclick=()=>{
          map.setView([d.latitude,d.longitude],15);
          markers[d.__i].openPopup();
        };
      }
      list.appendChild(div);
    });
  }

  function renderMap(l){
    markersLayer.clearLayers();
    markers=[];
    l.forEach(d=>{
      if(!d.valid) return;
      d.__i=markers.length;
      const m=L.marker([d.latitude,d.longitude])
        .bindPopup(popupHTML(d))
        .addTo(markersLayer);
      markers.push(m);
    });
  }

  search.oninput=()=>applyFilters(data);
  stateFilter.onchange=()=>applyFilters(data);
  cityFilter.onchange=()=>applyFilters(data);
  categoryFilter.onchange=()=>applyFilters(data);
});

function abrirPDF(){
  document.getElementById('pdfViewer').src=
    'PESQUISA - Pr√°ticas Comunicacionais e Culturais Quilombolas.pdf';
}

document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll('.tab,.tab-content')
      .forEach(e=>e.classList.remove('active'));
    t.classList.add('active');
    document.getElementById('tab-'+t.dataset.tab)
      .classList.add('active');
    setTimeout(()=>map.invalidateSize(),300);
  }
});
</script>

</body>
</html>

<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Mapeamento Cultural ‚Äì Instituto Suma√∫ma</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
html,body{margin:0;font-family:Arial,sans-serif}

/* ===== BANNER ===== */
#banner-pesquisa{
  width:100%;
}
.banner-topo{
  background:url('banner-capa.png') center/cover no-repeat;
  padding:60px 20px;
  color:#fff;
}
.banner-topo .conteudo{
  max-width:1100px;
  margin:auto;
}
.banner-topo h1{
  font-size:32px;
  line-height:1.2;
  margin-bottom:10px;
}
.banner-topo p{
  font-size:16px;
  max-width:750px;
}

.banner-rodape{
  background:url('banner-rodape.png') center/cover no-repeat;
  padding:30px 20px;
  display:flex;
  justify-content:center;
  gap:80px;
  flex-wrap:wrap;
}
.banner-rodape .bloco{
  text-align:center;
  color:#fff;
  font-size:14px;
}
.banner-rodape img{
  max-height:50px;
  margin-top:8px;
}

/* ===== LAYOUT ===== */
#container{
  position:relative;
  height:calc(100vh - 320px);
}

#sidebar{
  position:absolute;
  top:0;left:0;bottom:0;
  width:32%;
  max-width:420px;
  background:#fff;
  overflow:auto;
  z-index:1000;
  box-shadow:2px 0 6px rgba(0,0,0,.2);
}

#map{
  position:absolute;
  top:0;right:0;bottom:0;
  left:32%;
}

/* HEADER */
.header{
  padding:12px;
  border-bottom:1px solid #ddd;
}

/* TABS */
.tabs{
  display:flex;
  border-bottom:1px solid #ddd;
}
.tab{
  flex:1;
  padding:10px;
  text-align:center;
  cursor:pointer;
  font-weight:bold;
  background:#f5f5f5;
}
.tab.active{
  background:#111;
  color:#fff;
}

/* CONTENT */
.tab-content{display:none;padding:12px}
.tab-content.active{display:block}

/* FILTROS */
input,select{
  width:100%;
  padding:8px;
  margin-bottom:6px;
}

/* LISTA */
.item{
  border-bottom:1px solid #ddd;
  padding:8px;
  cursor:pointer;
}
.item:hover{background:#f2f2f2}
.item.invalid{background:#fff3f3}
.badge{
  display:inline-block;
  background:#d9534f;
  color:#fff;
  padding:2px 6px;
  font-size:11px;
  border-radius:4px;
  margin-top:4px;
}

/* PDF */
.pdf-actions{
  display:flex;
  gap:10px;
  margin-bottom:10px;
}
.pdf-actions a,
.pdf-actions button{
  flex:1;
  padding:10px;
  border:none;
  background:#2e7d32;
  color:#fff;
  cursor:pointer;
  border-radius:4px;
  font-weight:bold;
}
iframe{
  width:100%;
  height:70vh;
  border:none;
}

/* ===== MOBILE ===== */
@media(max-width:768px){
  #container{
    height:auto;
  }
  #sidebar{
    position:relative;
    width:100%;
    max-width:100%;
    height:auto;
    box-shadow:none;
  }
  #map{
    position:relative;
    left:0;
    width:100%;
    height:50vh;
  }
}
</style>
</head>

<body>

<!-- ===== BANNER ===== -->
<div id="banner-pesquisa">
  <div class="banner-topo">
    <div class="conteudo">
      <h1>Corpos-territ√≥rios quilombolas<br>e o fio conectado da ancestralidade</h1>
      <p>
        entre as agendas de justi√ßa clim√°tica e as pr√°ticas culturais
        e comunicacionais
      </p>
    </div>
  </div>

  <div class="banner-rodape">
    <div class="bloco">
      <div>Realiza√ß√£o</div>
      <img src="instituto_sumauma.png">
    </div>
    <div class="bloco">
      <div>Financiamento</div>
      <img src="climate_land_use_alliance.png">
    </div>
  </div>
</div>

<!-- ===== MAPA + SIDEBAR ===== -->
<div id="container">

  <div id="sidebar">
    <div class="header">
      <h3>Mapeamento Cultural</h3>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="mapa">Mapa Cultural</div>
      <div class="tab" data-tab="livro">Livro da Pesquisa</div>
    </div>

    <div id="tab-mapa" class="tab-content active">
      <input id="search" placeholder="Buscar por nome">
      <select id="stateFilter"><option value="">Estado</option></select>
      <select id="cityFilter"><option value="">Cidade</option></select>
      <select id="categoryFilter"><option value="">Categoria</option></select>
      <div id="list"></div>
    </div>

    <div id="tab-livro" class="tab-content">
      <div class="pdf-actions">
        <a href="PESQUISA - Pr√°ticas Comunicacionais e Culturais Quilombolas.pdf" download>üì• Baixar PDF</a>
        <button onclick="abrirPDF()">üìñ Ler aqui</button>
      </div>
      <iframe id="pdfViewer"></iframe>
    </div>
  </div>

  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const map = L.map('map').setView([-14.5,-52],4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);
const markersLayer = L.layerGroup().addTo(map);

let data=[];
fetch('Mapeamento_mestre.csv')
.then(r=>r.text())
.then(text=>{
  text=text.replace(/^\uFEFF/,'').trim();
  const lines=text.split('\n').filter(l=>l.trim());
  const sep=lines[0].includes(';')?';':',';
  const headers=lines[0].split(sep).map(h=>h.trim().toLowerCase());

  data=lines.slice(1).map(l=>{
    const c=l.split(sep);
    let o={};
    headers.forEach((h,i)=>o[h]=(c[i]||'').trim());

    const norm=v=>{
      if(!v) return null;
      v=v.replace(/\./g,'').replace(',','.');
      const n=parseFloat(v);
      return isNaN(n)?null:n;
    };

    o.latitude=norm(o.latitude);
    o.longitude=norm(o.longitude);
    o.valid=o.latitude&&o.longitude;
    o.nome=o.nome||o.titulo||'';

    return o;
  });

  populateFilters();
  applyFilters();
});

function populateFilters(){
  const s=new Set(),c=new Set(),k=new Set();
  data.forEach(d=>{
    if(d.estado) s.add(d.estado);
    if(d.cidade) c.add(d.cidade);
    if(d.categoria) k.add(d.categoria);
  });
  fill(stateFilter,s); fill(cityFilter,c); fill(categoryFilter,k);
}
function fill(el,set){
  set.forEach(v=>{
    const o=document.createElement('option');
    o.value=v;o.textContent=v;el.appendChild(o);
  });
}

function applyFilters(){
  const f=data.filter(d=>
    (!search.value||d.nome.toLowerCase().includes(search.value.toLowerCase())) &&
    (!stateFilter.value||d.estado===stateFilter.value) &&
    (!cityFilter.value||d.cidade===cityFilter.value) &&
    (!categoryFilter.value||d.categoria===categoryFilter.value)
  );
  renderList(f); renderMap(f);
}

const list=document.getElementById('list');
function renderList(l){
  list.innerHTML='';
  l.forEach(d=>{
    const div=document.createElement('div');
    div.className='item'+(!d.valid?' invalid':'');
    div.innerHTML=`<strong>${d.nome}</strong><br>${d.cidade||''} - ${d.estado||''}<br>${d.categoria||''}${!d.valid?'<div class="badge">Localiza√ß√£o pendente</div>':''}`;
    if(d.valid) div.onclick=()=>map.setView([d.latitude,d.longitude],15);
    list.appendChild(div);
  });
}

function renderMap(l){
  markersLayer.clearLayers();
  l.forEach(d=>{
    if(!d.valid) return;
    L.marker([d.latitude,d.longitude]).bindPopup(`<b>${d.nome}</b><br>${d.cidade} - ${d.estado}<br>${d.categoria}`).addTo(markersLayer);
  });
}

search.oninput=applyFilters;
stateFilter.onchange=applyFilters;
cityFilter.onchange=applyFilters;
categoryFilter.onchange=applyFilters;

document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll('.tab,.tab-content').forEach(e=>e.classList.remove('active'));
    t.classList.add('active');
    document.getElementById('tab-'+t.dataset.tab).classList.add('active');
    setTimeout(()=>map.invalidateSize(),300);
  }
});

function abrirPDF(){
  const i=document.getElementById('pdfViewer');
  i.src='PESQUISA - Pr√°ticas Comunicacionais e Culturais Quilombolas.pdf';
}
</script>

</body>
</html>

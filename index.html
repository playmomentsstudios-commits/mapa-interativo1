<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Mapeamento Cultural â€“ Instituto SumaÃºma</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
html,body{height:100%;margin:0;font-family:Arial,sans-serif}
body{overflow:hidden}

/* LAYOUT */
#sidebar{
  position:absolute;
  top:0;left:0;bottom:0;
  width:32%;
  max-width:420px;
  background:#fff;
  overflow:auto;
  z-index:1000;
  box-shadow:2px 0 6px rgba(0,0,0,.2);
}

#map{
  position:absolute;
  top:0;right:0;bottom:0;
  left:32%;
}

/* HEADER */
.header{
  padding:12px;
  border-bottom:1px solid #ddd;
}
.header h3{margin:0}

/* TABS */
.tabs{
  display:flex;
  border-bottom:1px solid #ddd;
}
.tab{
  flex:1;
  padding:10px;
  text-align:center;
  cursor:pointer;
  font-weight:bold;
  background:#f5f5f5;
}
.tab.active{
  background:#111;
  color:#fff;
}

/* CONTENT */
.tab-content{display:none;padding:12px}
.tab-content.active{display:block}

/* FILTROS */
input,select{
  width:100%;
  padding:8px;
  margin-bottom:6px;
}

.item{
  border-bottom:1px solid #ddd;
  padding:8px;
  cursor:pointer;
}
.item:hover{background:#f2f2f2}
.item.invalid{background:#fff3f3}
.badge{
  display:inline-block;
  background:#d9534f;
  color:#fff;
  padding:2px 6px;
  font-size:11px;
  border-radius:4px;
  margin-top:4px;
}

/* PDF */
.pdf-actions{
  display:flex;
  gap:10px;
  margin-bottom:10px;
}
.pdf-actions a,
.pdf-actions button{
  flex:1;
  padding:10px;
  border:none;
  background:#2e7d32; /* VERDE */
  color:#fff;
  cursor:pointer;
  text-align:center;
  text-decoration:none;
  border-radius:4px;
  font-weight:bold;
}
iframe{
  width:100%;
  height:70vh;
  border:none;
}
</style>
</head>

<body>

<div id="sidebar">

  <div class="header">
    <h3>Mapeamento Cultural</h3>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="mapa">Mapa Cultural</div>
    <div class="tab" data-tab="livro">Livro da Pesquisa</div>
  </div>

  <div id="tab-mapa" class="tab-content active">
    <input id="search" placeholder="Buscar por nome">
    <select id="stateFilter"><option value="">Estado</option></select>
    <select id="cityFilter"><option value="">Cidade</option></select>
    <select id="categoryFilter"><option value="">Categoria</option></select>
    <div id="list"></div>
  </div>

  <div id="tab-livro" class="tab-content">
    <div class="pdf-actions">
      <a href="PESQUISA - PrÃ¡ticas Comunicacionais e Culturais Quilombolas.pdf" download>
        ðŸ“¥ Baixar PDF
      </a>
      <button onclick="abrirPDF()">ðŸ“– Ler aqui</button>
    </div>
    <iframe id="pdfViewer" style="display:none"></iframe>
  </div>

</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
/* ================= MAPA ================= */
const map = L.map('map').setView([-14.5,-52],4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'Â© OpenStreetMap'
}).addTo(map);

const markersLayer = L.layerGroup().addTo(map);

/* ================= CSV ================= */
let data = [];

fetch('Mapeamento_mestre.csv')
  .then(r=>r.text())
  .then(text=>{
    const lines = text.split('\n');
    const headers = lines[0].split(';').map(h=>h.trim().toLowerCase());

    data = lines.slice(1).map(l=>{
      const cols = l.split(';');
      let o = {};
      headers.forEach((h,i)=>o[h]=cols[i]?.trim());

      function normalizeCoord(v){
        if(!v) return null;
        v = v.toString().trim();
        const dots = (v.match(/\./g)||[]).length;
        if(dots > 1) v = v.replace(/\./g,'');
        v = v.replace(',','.');
        const n = parseFloat(v);
        return isNaN(n) ? null : n;
      }

      const lat = o.latitude || o.Latitude || o.lat || o.LATITUDE;
      const lng = o.longitude || o.Longitude || o.lng || o.LONGITUDE;

      o.latitude  = normalizeCoord(lat);
      o.longitude = normalizeCoord(lng);

      o.valid = typeof o.latitude === 'number'
             && typeof o.longitude === 'number';

      return o;
    });

    populateFilters();
    applyFilters();
  });

/* ================= FILTROS ================= */
function populateFilters(){
  const s=new Set(), c=new Set(), k=new Set();
  data.forEach(d=>{
    if(d.estado) s.add(d.estado);
    if(d.cidade) c.add(d.cidade);
    if(d.categoria) k.add(d.categoria);
  });
  fill('stateFilter',s);
  fill('cityFilter',c);
  fill('categoryFilter',k);
}
function fill(id,set){
  const el=document.getElementById(id);
  set.forEach(v=>{
    const o=document.createElement('option');
    o.value=v;o.textContent=v;
    el.appendChild(o);
  });
}

function applyFilters(){
  const q=search.value.toLowerCase();
  const st=stateFilter.value;
  const ct=cityFilter.value;
  const cat=categoryFilter.value;

  const f=data.filter(d=>
    (!q||d.nome?.toLowerCase().includes(q)) &&
    (!st||d.estado===st) &&
    (!ct||d.cidade===ct) &&
    (!cat||d.categoria===cat)
  );

  renderList(f);
  renderMap(f);
}

/* ================= LISTA ================= */
function renderList(list){
  listDiv.innerHTML='';
  list.forEach(d=>{
    const div=document.createElement('div');
    div.className='item'+(!d.valid?' invalid':'');
    div.innerHTML=`
      <strong>${d.nome||'Sem nome'}</strong><br>
      ${d.cidade||''} - ${d.estado||''}<br>
      ${d.categoria||''}
      ${!d.valid?'<div class="badge">LocalizaÃ§Ã£o pendente</div>':''}
    `;
    if(d.valid){
      div.onclick=()=>map.setView([d.latitude,d.longitude],15);
    }
    listDiv.appendChild(div);
  });
}

/* ================= MAPA ================= */
function renderMap(list){
  markersLayer.clearLayers();
  list.forEach(d=>{
    if(!d.valid) return;
    L.marker([d.latitude,d.longitude])
      .bindPopup(`
        <b>${d.nome}</b><br>
        ${d.cidade} - ${d.estado}<br>
        ${d.categoria}<br>
        ${d.contato||''}
      `)
      .addTo(markersLayer);
  });
}

/* ================= EVENTOS ================= */
search.oninput=applyFilters;
stateFilter.onchange=applyFilters;
cityFilter.onchange=applyFilters;
categoryFilter.onchange=applyFilters;

/* ================= TABS ================= */
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll('.tab,.tab-content')
      .forEach(e=>e.classList.remove('active'));
    t.classList.add('active');
    document.getElementById('tab-'+t.dataset.tab).classList.add('active');
    setTimeout(()=>map.invalidateSize(),300);
  }
});

/* ================= PDF ================= */
function abrirPDF(){
  const iframe=document.getElementById('pdfViewer');
  iframe.src='PESQUISA - PrÃ¡ticas Comunicacionais e Culturais Quilombolas.pdf';
  iframe.style.display='block';
}

const listDiv=document.getElementById('list');
</script>

</body>
</html>

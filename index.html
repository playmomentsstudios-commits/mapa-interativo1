<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Mapa Interativo Cultural</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
html,body,#map{height:100%;margin:0}
#map{position:absolute;left:320px;right:0}
#sidebar{
  position:absolute;left:0;top:0;bottom:0;width:320px;
  background:#fff;overflow:auto;padding:12px;
  box-shadow:2px 0 6px rgba(0,0,0,.2)
}
.item{border-bottom:1px solid #ddd;padding:8px}
button{margin:4px 0;padding:6px;width:100%}
input,select{width:100%;padding:6px;margin-bottom:6px}
.status{font-size:13px;color:#444}
</style>
</head>

<body>

<div id="sidebar">
  <h3>Mapeamento Cultural</h3>
  <input id="search" placeholder="Buscar por nome, cidade ou estado">
  <select id="stateFilter">
    <option value="">Filtrar por estado</option>
  </select>
  <div id="list"></div>
  <div class="status" id="status">Status: pronto</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const map = L.map('map').setView([-14.5,-52],4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let geoData = [];
let markersLayer = L.layerGroup().addTo(map);

// ===============================
// CARREGAR DADOS
// ===============================
fetch('mapeamento.geojson')
  .then(r => r.json())
  .then(d => {
    geoData = d.features || [];
    populateFilters();
    applyFilters();
  });

// ===============================
// FILTROS
// ===============================
function populateFilters(){
  const stateSelect = document.getElementById('stateFilter');
  stateSelect.innerHTML = '<option value="">Filtrar por estado</option>';

  const states = new Set();
  geoData.forEach(f => {
    if(f.properties?.ESTADO) states.add(f.properties.ESTADO);
  });

  states.forEach(s => {
    const o = document.createElement('option');
    o.value = s;
    o.textContent = s;
    stateSelect.appendChild(o);
  });
}

function applyFilters(){
  const q = document.getElementById('search').value.toLowerCase();
  const state = document.getElementById('stateFilter').value;

  const filtered = geoData.filter(f => {
    const p = f.properties || {};
    const text = `
      ${p["COLETIVO/NOME"]||""}
      ${p.CIDADE||""}
      ${p.ESTADO||""}
    `.toLowerCase();

    return (!q || text.includes(q)) &&
           (!state || p.ESTADO === state);
  });

  renderList(filtered);
  renderMap(filtered);
}

// ===============================
// LISTA
// ===============================
function renderList(data){
  const list = document.getElementById('list');
  list.innerHTML = '';

  data.forEach(f => {
    const p = f.properties || {};
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `
      <strong>${p["COLETIVO/NOME"]||"Sem nome"}</strong><br>
      ${p.CIDADE||""} - ${p.ESTADO||""}
    `;
    div.onclick = () => {
      if(f.geometry?.coordinates){
        const [lng,lat] = f.geometry.coordinates;
        map.setView([lat,lng],15);
      }
    };
    list.appendChild(div);
  });

  document.getElementById('status').innerText =
    `Resultados: ${data.length}`;
}

// ===============================
// MAPA
// ===============================
function renderMap(data){
  markersLayer.clearLayers();

  data.forEach(f => {
    if(!f.geometry?.coordinates) return;
    const [lng,lat] = f.geometry.coordinates;

    L.marker([lat,lng])
      .bindPopup(`<b>${f.properties?.["COLETIVO/NOME"]||""}</b>`)
      .addTo(markersLayer);
  });
}

// ===============================
// EVENTOS
// ===============================
document.getElementById('search')
  .addEventListener('input', applyFilters);

document.getElementById('stateFilter')
  .addEventListener('change', applyFilters);

</script>
</body>
</html>

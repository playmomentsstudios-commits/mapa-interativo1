<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Mapeamento Cultural – Instituto Sumaúma</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
html,body{
  margin:0;
  height:100%;
  font-family:Arial,sans-serif;
}

/* ===== HEADER ===== */
header{
  background:#0f3d2e;
  color:#fff;
}
.header-top{
  height:80px;
  display:flex;
  align-items:center;
  padding:0 20px;
}
.header-top img{
  height:45px;
  margin-right:15px;
}
.header-banner{
  height:220px;
  background:url('banner-capa.png') center/cover no-repeat;
}

/* ===== LAYOUT ===== */
#layout{
  display:flex;
  height:calc(100% - 300px);
}

/* ===== SIDEBAR ===== */
#sidebar{
  width:420px;
  background:#fff;
  border-right:1px solid #ddd;
  overflow-y:auto;
}
.sidebar-inner{
  padding:20px;
}
input,select{
  width:100%;
  padding:8px;
  margin-bottom:10px;
}

/* ===== RESULTADOS ===== */
.item{
  border:1px solid #ddd;
  padding:10px;
  margin-bottom:8px;
  cursor:pointer;
}
.item:hover{
  background:#f2f2f2;
}

/* ===== MAPA ===== */
#content{
  flex:1;
  position:relative;
}
#map{
  width:100%;
  height:100%;
}

/* ===== DETALHES ===== */
#details{
  display:none;
  position:absolute;
  right:0;
  top:0;
  width:420px;
  height:100%;
  background:#fff;
  border-left:1px solid #ddd;
  padding:20px;
  overflow-y:auto;
  z-index:999;
}
.show-details #details{display:block;}
.full-map #sidebar,
.full-map #details{display:none;}

/* ===== BOTÕES ===== */
.btn{
  display:inline-block;
  padding:10px 14px;
  margin-top:10px;
  margin-right:8px;
  color:#fff;
  border-radius:4px;
  text-decoration:none;
  cursor:pointer;
}
.btn-contact{background:#25D366;}
.btn-map{background:#0f3d2e;}
</style>
</head>

<body>

<header>
  <div class="header-top">
    <img src="instituto_sumauma.png">
    <h1>Mapeamento Cultural</h1>
  </div>
  <div class="header-banner"></div>
</header>

<div id="layout">

  <!-- SIDEBAR -->
  <aside id="sidebar">
    <div class="sidebar-inner">

      <input type="text" id="search" placeholder="Buscar por nome...">

      <select id="filterEstado">
        <option value="">Todos os estados</option>
      </select>

      <select id="filterCategoria">
        <option value="">Todas as categorias</option>
      </select>

      <div id="results"></div>

    </div>
  </aside>

  <!-- MAPA -->
  <section id="content">
    <div id="map"></div>
    <div id="details"></div>
  </section>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const map = L.map('map').setView([-14.235, -51.9253], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'© OpenStreetMap'
}).addTo(map);

let dados = [];
let markers = [];

fetch('Mapeamento_mestre.csv')
  .then(r => r.text())
  .then(text => {
    dados = parseCSV(text);
    popularFiltros(dados);
    renderizar(dados);
  });

function parseCSV(text){
  const linhas = text.trim().split('\n');
  const cab = linhas.shift().split(',').map(h=>h.trim().toLowerCase());
  return linhas.map(l=>{
    const v = l.split(',');
    let o = {};
    cab.forEach((c,i)=>o[c]=v[i]?.trim());
    return o;
  });
}

function popularFiltros(data){
  const estados = [...new Set(data.map(d=>d.estado))];
  const cats = [...new Set(data.map(d=>d.categoria))];
  estados.forEach(e=>filterEstado.innerHTML+=`<option>${e}</option>`);
  cats.forEach(c=>filterCategoria.innerHTML+=`<option>${c}</option>`);
}

function renderizar(data){
  results.innerHTML='';
  markers.forEach(m=>map.removeLayer(m));
  markers=[];

  data.forEach(d=>{
    if(!d.latitude||!d.longitude)return;

    const lat=+d.latitude,lng=+d.longitude;
    const marker=L.marker([lat,lng]).addTo(map);
    markers.push(marker);

    const div=document.createElement('div');
    div.className='item';
    div.innerHTML=`<strong>${d.nome}</strong><br>${d.cidade} - ${d.estado}<br>${d.categoria}`;
    div.onclick=()=>abrirDetalhes(d,lat,lng);
    results.appendChild(div);
  });
}

function abrirDetalhes(d,lat,lng){
  document.body.classList.add('show-details');
  details.innerHTML=`
    <h2>${d.nome}</h2>
    <p><b>Cidade:</b> ${d.cidade} - ${d.estado}</p>
    <p><b>Categoria:</b> ${d.categoria}</p>
    <p>${d.descricao||''}</p>
    ${d.contato?`<a class="btn btn-contact" href="${d.contato}" target="_blank">Entrar em contato</a>`:''}
    <button class="btn btn-map" onclick="verNoMapa(${lat},${lng})">Ver no mapa</button>
  `;
}

function verNoMapa(lat,lng){
  document.body.classList.add('full-map');
  map.setView([lat,lng],15);
}

search.oninput=aplicarFiltros;
filterEstado.onchange=aplicarFiltros;
filterCategoria.onchange=aplicarFiltros;

function aplicarFiltros(){
  const s=search.value.toLowerCase();
  renderizar(dados.filter(d=>
    (!s||d.nome.toLowerCase().includes(s)) &&
    (!filterEstado.value||d.estado===filterEstado.value) &&
    (!filterCategoria.value||d.categoria===filterCategoria.value)
  ));
}
</script>

</body>
</html>

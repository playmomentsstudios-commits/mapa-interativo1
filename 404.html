<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Mapeamento Cultural ‚Äì Instituto Suma√∫ma</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
/* ====== CSS INTEGRADO E AJUSTADO ====== */
html,body{margin:0;height:100%;font-family:Arial,sans-serif;}
.header{position:relative;height:160px;background:url('/banner-capa.png') center/cover no-repeat;}
.header-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:space-between;padding:0 30px;background:rgba(0,0,0,.35);}

/* ESTILO DO NOVO T√çTULO EM TEXTO */
.header-left a {text-decoration: none;}
.brand-title {
    color: #ffffff;
    font-size: 28px;
    font-weight: 800;
    line-height: 1.1;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.6);
    margin: 0;
}
.brand-subtitle {
    display: block;
    color: #ffdd9a;
    font-size: 14px;
    font-weight: normal;
    letter-spacing: 2px;
    margin-top: 5px;
}

.menu{display:flex;gap:30px;align-items:center;}
.menu a{color:#fff;text-decoration:none;font-size:16px;cursor:pointer;}
.menu-logo{height:50px;width:auto;}
.menu-toggle{display:none;font-size:28px;color:#fff;cursor:pointer;}

@media(max-width:768px){
    .menu{display:none}
    .menu-toggle{display:block}
    .header{height:180px}
    .brand-title {font-size: 22px;}
}

.mobile-menu{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:5000;padding:40px 30px;}
.mobile-menu a{display:block;color:#fff;font-size:22px;margin-bottom:25px;text-decoration:none;}
.mobile-menu .close{font-size:28px;color:#fff;cursor:pointer;margin-bottom:40px;}

#layout{display:flex;height:calc(100% - 160px);}
#sidebar{width:420px;background:#fff;border-right:1px solid #ddd;overflow-y:auto;}
.sidebar-inner{padding:20px;}
input,select{width:100%;height:44px;padding:10px;margin-bottom:10px;box-sizing:border-box;}
.item{background:#0f3d2e;color:#fff;border-radius:4px;padding:12px;margin-bottom:10px;cursor:pointer;}
.item:hover{background:#145743;}
.tag-pendente{color:#ffdd9a;font-size:12px;}
#content{flex:1;position:relative;}
#map{width:100%;height:100%;}
#details{display:none;position:absolute;right:0;top:0;width:420px;height:100%;background:#fff;border-left:1px solid #ddd;padding:20px;overflow-y:auto;z-index:1000;}
.show-details #details{display:block;}
.full-map #sidebar,.full-map #details{display:none;}
#details h2{color:#0f3d2e;}
.info-line{margin-bottom:10px;font-size:15px;}
.info-line b{color:#0f3d2e;}
.info-icons{display:flex;gap:12px;margin:15px 0;}
.info-icons a{width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;text-decoration:none;font-size:18px;}
.whatsapp{background:#25D366;}
.site{background:#0f3d2e;}
.instagram{background:#C13584;}
.map-icon{background:#1e88e5;}
.btn-map-view{display:inline-block;padding:12px 18px;background:#0f3d2e;color:#fff;border-radius:4px;cursor:pointer;}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:4000;align-items:center;justify-content:center;}
.modal-content{background:#fff;width:90%;max-width:500px;padding:30px;border-radius:6px;text-align:center;position:relative;}
.modal-content img{width:200px;margin-bottom:20px;}
.modal-content a{display:inline-block;margin:10px;padding:12px 18px;color:#fff;text-decoration:none;border-radius:4px;}
.btn-read{background:#0f3d2e;}
.btn-download{background:#25D366;}
.close{position:absolute;top:10px;right:15px;font-size:22px;cursor:pointer;}
</style>
</head>
<body>

<header class="header">
  <div class="header-overlay">
    <div class="header-left">
      <a href="/">
        <h1 class="brand-title">Mapeamento de pr√°ticas culturais<br>e comunicacionais quilombolas
        
        </h1>
      </a>
    </div>
    <div class="menu-toggle" onclick="abrirMenu()">‚ò∞</div>
    <nav class="menu">
      <img src="/instituto_sumauma.png" class="menu-logo" alt="Logo Instituto Suma√∫ma">
      <a href="/">In√≠cio</a>
      <a href="/pesquisa.html">Pesquisa</a>
      <a onclick="abrirRelat√≥rio()">Relat√≥rio</a>
      <a href="/ficha-tecnica.html">Ficha T√©cnica</a>
      <a href="https://www.sumauma.org/" target="_blank">Institucional</a>
    </nav>
  </div>
</header>

<div class="mobile-menu" id="mobileMenu">
  <div class="close" onclick="fecharMenu()">‚úï</div>
  <a href="/">In√≠cio</a>
  <a href="/pesquisa.html">Pesquisa</a>
  <a onclick="abrirRelat√≥rio();fecharMenu()">Relat√≥rio</a>
  <a href="/ficha-tecnica.html">Ficha T√©cnica</a>
  <a href="https://www.sumauma.org/" target="_blank">Institucional</a>
</div>

<div id="layout">
  <aside id="sidebar">
    <div class="sidebar-inner">
      <input id="search" placeholder="Buscar por nome...">
      <select id="filterEstado"><option value="">Todos os estados</option></select>
      <select id="filterCidade"><option value="">Todas as cidades</option></select>
      <select id="filterCategoria"><option value="">Todas as categorias</option></select>
      <div id="results"></div>
    </div>
  </aside>
  <section id="content"><div id="map"></div><div id="details"></div></section>
</div>

<div class="modal" id="modalRelat√≥rio">
  <div class="modal-content">
    <span class="close" onclick="fecharRelat√≥rio()">√ó</span>
    <img src="/capa-livro.jpg">
    <h2>Pr√°ticas Comunicacionais e Culturais Quilombolas</h2>
    <p>Panorama das pr√°ticas comunicacionais quilombolas no Brasil.</p>
    <a class="btn-read" href="/PESQUISA - Pr√°ticas Comunicacionais e Culturais Quilombolas.pdf" target="_blank">üìñ Ler online</a>
    <a class="btn-download" href="/PESQUISA - Pr√°ticas Comunicacionais e Culturais Quilombolas.pdf" download>üì• Baixar PDF</a>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
function abrirMenu(){document.getElementById('mobileMenu').style.display='block';}
function fecharMenu(){document.getElementById('mobileMenu').style.display='none';}
function abrirLivro(){document.getElementById('modalLivro').style.display='flex';}
function fecharLivro(){document.getElementById('modalLivro').style.display='none';}

const map = L.map('map').setView([-14.235, -51.9253], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);

let dados = [], markers = [];

/* CAMINHO ABSOLUTO PARA O CSV NA RAIZ DO SUBDOM√çNIO */
fetch('/Mapeamento_mestre.csv')
.then(r=>r.text())
.then(text=>{
  dados = parseCSV(text);
  popularFiltros(dados);
  renderizar(dados);
  setTimeout(()=>map.invalidateSize(),300);
});

function parseCSV(text){
  const rows=[],headers=[];
  let cur=[],val='',q=false;
  for(let i=0;i<text.length;i++){
    const c=text[i],n=text[i+1];
    if(c=='"'&&q&&n=='"'){val+='"';i++;}
    else if(c=='"'){q=!q;}
    else if(c==','&&!q){cur.push(val);val='';}
    else if(c=='\n'&&!q){cur.push(val);rows.push(cur);cur=[];val='';}
    else{val+=c;}
  }
  if(val){cur.push(val);rows.push(cur);}
  if(rows.length > 0) {
    headers.push(...rows.shift().map(h=>h.toLowerCase()));
    return rows.map(r=>{
      let o={};headers.forEach((h,i)=>o[h]=r[i]||'');return o;
    });
  }
  return [];
}

function popularFiltros(data){
  const estados=new Set(),categorias=new Set();
  data.forEach(d=>{ if(d.estado) estados.add(d.estado); if(d.categoria) categorias.add(d.categoria); });
  const fE = document.getElementById('filterEstado');
  const fCa = document.getElementById('filterCategoria');
  estados.forEach(e=>fE.innerHTML+=`<option>${e}</option>`);
  categorias.forEach(c=>fCa.innerHTML+=`<option>${c}</option>`);
}

function atualizarCidades(){
  const fE = document.getElementById('filterEstado');
  const fCi = document.getElementById('filterCidade');
  fCi.innerHTML='<option value="">Todas as cidades</option>';
  dados.filter(d=>!fE.value||d.estado===fE.value)
       .map(d=>d.cidade).filter((v,i,a)=>v&&a.indexOf(v)===i)
       .forEach(c=>fCi.innerHTML+=`<option>${c}</option>`);
}

function aplicarFiltros(){
  const s=document.getElementById('search').value.toLowerCase();
  const fE = document.getElementById('filterEstado').value;
  const fCi = document.getElementById('filterCidade').value;
  const fCa = document.getElementById('filterCategoria').value;
  renderizar(dados.filter(d=>(!s||d.nome.toLowerCase().includes(s)) && (!fE||d.estado===fE) && (!fCi||d.cidade===fCi) && (!fCa||d.categoria===fCa)));
}

document.getElementById('search').oninput=aplicarFiltros;
document.getElementById('filterEstado').onchange=()=>{atualizarCidades();aplicarFiltros();};
document.getElementById('filterCidade').onchange=aplicarFiltros;
document.getElementById('filterCategoria').onchange=aplicarFiltros;

function renderizar(lista){
  const res = document.getElementById('results');
  res.innerHTML='';
  markers.forEach(m=>map.removeLayer(m));
  markers=[];
  lista.forEach(d=>{
    const temLoc=d.latitude&&d.longitude&&!isNaN(d.latitude);
    const div=document.createElement('div');
    div.className='item';
    div.innerHTML=`<strong>${d.nome}</strong><br>${d.cidade} - ${d.estado}<br>${d.categoria}${!temLoc?'<div class="tag-pendente">üìç Localiza√ß√£o pendente</div>':''}`;
    div.onclick=()=>abrirDetalhes(d);
    res.appendChild(div);
    if(temLoc) markers.push(L.marker([+d.latitude,+d.longitude]).addTo(map));
  });
}

function abrirDetalhes(d){
  const det = document.getElementById('details');
  const temLoc=d.latitude&&d.longitude&&!isNaN(d.latitude);
  let icons='';
  if(d.link) icons+=`<a class="site" href="${d.link}" target="_blank">üîó</a>`;
  if(temLoc) icons+=`<a class="map-icon" onclick="verNoMapa(${d.latitude},${d.longitude})">üìç</a>`;
  det.innerHTML=`<h2>${d.nome}</h2><div class="info-line"><b>Cidade:</b> ${d.cidade} - ${d.estado}</div><div class="info-line"><b>Categoria:</b> ${d.categoria}</div>${d.descricao?`<div class="info-line"><b>Descri√ß√£o:</b> ${d.descricao}</div>`:''}<div class="info-icons">${icons}</div>${temLoc?`<a class="btn-map-view" onclick="verNoMapa(${d.latitude},${d.longitude})">Ver no mapa</a>`:''}`;
  document.body.classList.add('show-details');
}

function verNoMapa(lat,lng){document.body.classList.add('full-map');map.setView([lat,lng],15);}
</script>
</body>
</html>
